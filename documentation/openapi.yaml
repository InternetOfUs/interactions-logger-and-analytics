# OpenAPI version identifier - required for OpenAPI 3.0 domains
openapi: 3.0.0

#######################
# Optional info section
#######################
info:

  title: Memorable Experience
  description: "

    This document details the APIs exposed by the MemEx big data platform, realise by U-Hopper srl within the context of the FESR-funded Memorable Experiences (MemEx) project. The platform logs all interactions among tourists and a purposefully designed chatbot.

    There are three kind of implemented APIs:

    1. messages: to store, retrieve and delete messages;

    2. logs: to store, retrieve and delete logs;

    3. analytics/performances: to retrieve some performances of the system.


    A part from the entities and models representing the responses, there are three main entities involved in the system: `Message`, `Log` and `Performance`.

    A message can be a `ResponseMessage`, a `RequestMessage` or a `Notification`. A response message represents a response to a request message while the latter represent a message from the user. A notification is a special kind of message sent, for example, by the local administration or the hotel.


    Concerning `Log`, it represents a metric to track the status of the system and what drove to a particular choice.

    "

  version: "0.0.5"
  contact:
    email: "massimiliano.luca@unitn.it"

# servers:
#   - url: memex.u-hopper.com
#   - url: http://0.0.0.0:80/

tags:

  - name: message
    description: APIs to log the conversation into the database
  - name: logging
    description: APIs to log additional information of the modules
  - name: analytics
    description: APIs to retrieve useful information from the database. What follows can be used to analyze the performances of the bot

paths:

    # MESSAGES APIS
    /messages:
      post:
        tags:
          - message
        summary: Add a batch of messages
        description: This end-point allows to log a set of messages into the database
        requestBody:
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Messages'
        responses:
          '201':
            description: messages stored
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_201_list'
          '400':
            description: malformed message
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_400'
          '500':
            description: internal server error
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_500'

    /message:
      get:
        tags:
          - message
        summary: Retrieve a single message
        description: This end-point allows to retrieve all the information of a single message from the database, it is necessary to specify the `project`, the `messageId` and the `userId`, or instead of specifying these three parameters is possible to specify only the `traceId`
        parameters:
          - in: query
            name: project
            schema:
              type: string
            example: "MeMex"
            description: the name of the project related to the message you want to retrieve
          - in: query
            name: messageId
            schema:
              type: string
            example: "2A6F67A4-42D2-4DE0-9F00-DE4A564A83A8"
            description: the id of the message you want to retrieve
          - in: query
            name: userId
            schema:
              type: string
            example: "USR-JDKHEIU2-31NJDTE94"
            description: the id of the user you want to retrieve
          - in: query
            name: traceId
            schema:
              type: string
            example: "bcpg8XYBHD_pmQ1jA7b8"
            description: the trace id of the message you want to retrieve
        responses:
          '200':
            description: message retrived
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/MessageRetrieved'
          '400':
            description: malformed request
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_400'
          '404':
            description: message not found
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_404_basic'
          '500':
            description: internal server error
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_500'

      delete:
        tags:
          - message
        summary: Delete a message
        description: This end-point allows to delete a message from the database, it is necessary to specify the `project`, the `messageId` and the `userId`, or instead of specifying these three parameters is possible to specify only the `traceId`
        parameters:
          - in: query
            name: project
            schema:
              type: string
            example: "MeMex"
            description: the name of the project related to the message you want to delete
          - in: query
            name: messageId
            schema:
              type: string
            example: "2A6F67A4-42D2-4DE0-9F00-DE4A564A83A8"
            description: The id of the message you want to delete
          - in: query
            name: userId
            schema:
              type: string
            example: "USR-JDKHEIU2-31NJDTE94"
            description: the id of the user you want to delete
          - in: query
            name: traceId
            schema:
              type: string
            example: "bcpg8XYBHD_pmQ1jA7b8"
            description: the traceId of the message you want to delete
        responses:
          '200':
            description: message deleted
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_200_basic'
          '400':
            description: malformed request
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_400'
          '500':
            description: internal server error
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_500'

    # LOG APIS
    /logs:
      post:
        tags:
          - logging
        summary: Add a batch of messages to the database
        description: This end-point allows to log a set of messages into the database
        requestBody:
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Logs'
        responses:
          '201':
            description: success
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_201_list'
          '400':
            description: malformed log
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_400'

    /log:
      get:
        tags:
          - logging
        summary: Retrieve a single log by specifying the trace id
        description: This end-point can be used to retrieve all the information of a single log
        parameters:
          - in: path
            name: id
            schema:
              type: string
            required: true
            description: The trace id of the log
        responses:
          '200':
            description: success
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/Log'

          '404':
            description: log not found
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_404'

      put:
        tags:
          - logging
        summary: Update an already existing log
        description: This method should be used to update existing logs
        parameters:
          - in: path
            name: id
            schema:
              type: string
            required: true
            description: The id of the log
        responses:
          '200':
            description: Log updated
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_201'
          '404':
            description: Log not found
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_404'

      delete:
        tags:
          - logging
        summary: Delete a log
        description: This method should be used to delete a log from the database
        parameters:
          - in: path
            name: id
            schema:
              type: string
            required: true
            description: The  id of the log
        responses:
          '200':
            description: Log removed
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_200'
          '404':
            description: Log not found
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_404'

    # ANALYTICS APIS
    /analytics:
      post:
        tags:
          - analytics
        summary: Require an analytic
        description: This end-point allows to retrieve an analytic from the database
        requestBody:
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Analytic'
        responses:
          '200':
            description: success
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_200_ANALYTIC'
          '500':
            description: malformed log
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/HTTP_500_ANALYTIC'

    /analytics/usercount:
      get:
        tags:
          - analytics
        parameters:
          - in: query
            name: userId
            schema:
              type: string
            required: true
            description: the identifier of the user for which you want to count the clicks
        summary: Retrieve the number click based on a user identifier
        description: Retrieve the number click based on a user identifier
        responses:
          '200':
            description: success
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/200_user_count'

    /analytics/eventcount:
      get:
        tags:
          - analytics
        parameters:
          - in: query
            name: eventId
            schema:
              type: string
            required: true
            description: the identifier of the evnet for which you want to count the clicks
        summary: Retrieve the number click based on an event identifier
        description: Retrieve the number click based on an event identifier
        responses:
          '200':
            description: success
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/200_event_count'

    # DOCUMENTATION API
    /documentation:
      get:
        tags:
          - documentation
        summary: Retrieve the documentation
        description: Retrieve the documentation in a yaml format
        responses:
          '200':
            description: success

components:

  ####################
  # Common data models
  ####################
  schemas:

    Messages:
      type: array
      items:
        oneOf:
          - $ref: '#/components/schemas/RequestMessage'
          - $ref: '#/components/schemas/ResponseMessage'
          - $ref: '#/components/schemas/NotificationMessage'

    MessageRetrieved:
      type: object
      oneOf:
        - $ref: '#/components/schemas/RequestMessage'
        - $ref: '#/components/schemas/ResponseMessage'
        - $ref: '#/components/schemas/NotificationMessage'
      properties:
        traceId:
          type: string
          example: "bcpg8XYBHD_pmQ1jA7b8"
      example: { "messageId": "2A6F67A4-42D2-4DE0-9F00-DE4A564A83A8", "channel": "FACEBOOK", "userId": "USR-JDKHEIU2-31NJDTE94", "conversationId": "CONV-DAJKWPENVOA-314CAD", "timestamp": "2020-01-19 17:21:00", "content": { "type": "text", "value": "devo fare un bonifico di 40 euro" }, "domain": "pagamenti", "intent": { "name": "bonifico", "confidence": 0.87 }, "entities": [ { "type": "@city", "value": "Boston", "confidence": 0.94 } ], "project": "MeMex", "language": "IT", "metadata": { }, "type": "REQUEST", "traceId": "bcpg8XYBHD_pmQ1jA7b8" }

    RequestMessage:
      type: object
      properties:
        messageId:
          type: string
          example: "2A6F67A4-42D2-4DE0-9F00-DE4A564A83A8"
        channel:
          type: string
          example: "FACEBOOK"
        userId:
          type: string
          example: "USR-JDKHEIU2-31NJDTE94"
        conversationId:
          type: string
          example: "CONV-DAJKWPENVOA-314CAD"
        timestamp:
          type: string
          example: "2020-01-19 17:21:00"
        content:
          oneOf:
            - $ref: '#/components/schemas/TextualRequest'
            - $ref: '#/components/schemas/ActionRequest'
            - $ref: '#/components/schemas/AttachmentRequest'
            - $ref: '#/components/schemas/LocationRequest'
            - $ref: '#/components/schemas/UserInfoRequest'
          example: { "type": "text", "value": "devo fare un bonifico di 40 euro" }
        domain:
          type: string
          example: "pagamenti"
        intent:
          type: object
          properties:
            name:
              type: string
              example: "bonifico"
            confidence:
              type: number
              format: float
              example: 0.87
        entities:
          type: array
          items:
            $ref: '#/components/schemas/Entity'
        project:
          type: string
          example: "MeMex"
        language:
          type: string
          example: "IT"
        metadata:
          type: object
        type:
          type: string
          enum: [ "REQUEST" ]
          example: "REQUEST"
      required:
        - messageId
        - channel
        - userId
        - timestamp
        - project
        - type

    ResponseMessage:
      type: object
      properties:
        messageId:
          type: string
          example: "2A6F67A4-42D2-4DE0-9F00-DE4A564A83A9"
        conversationId:
          type: string
          example: "CONV-DOWI41-DAJPRTI3"
        channel:
          type: string
          example: "FACEBOOK"
        userId:
          type: string
          example: "USR-JDKHEIU2-31NJDTE94"
        responseTo:
          type: string
          example: "1FKNSM-GEKRO2-DANK2-FJ33-DASDJOW"
        timestamp:
          type: string
          example: "2020-01-19 17:21:00"
        content:
          oneOf:
            - $ref: '#/components/schemas/TextualResponse'
            - $ref: '#/components/schemas/MultiActionResponse'
            - $ref: '#/components/schemas/AttachmentResponse'
            - $ref: '#/components/schemas/CarouselResponse'
            - $ref: '#/components/schemas/LocationResponse'
          example: { "type": "text", "value": "va bene" }
        metadata:
          type: object
        project:
          type: string
          example: "MemEx"
        type:
          type: string
          enum: [ "RESPONSE" ]
          example: "RESPONSE"
      required:
        - messageId
        - channel
        - userId
        - responseTo
        - timestamp
        - project
        - type

    NotificationMessage:
      type: object
      properties:
        messageId:
          type: string
          example: "2A6F67A4-42D2-4DE0-9F00-DE4A564A83A0"
        conversationId:
          type: string
          example: "CONV-DOWI41-DAJPRTI3"
        channel:
          type: string
          example: "FACEBOOK"
        userId:
          type: string
          example: "USR-JDKHEIU2-31NJDTE94"
        timestamp:
          type: string
          example: "2020-01-19 17:21:00"
        content:
          oneOf:
            - $ref: '#/components/schemas/TextualResponse'
            - $ref: '#/components/schemas/ActionResponse'
            - $ref: '#/components/schemas/AttachmentResponse'
            - $ref: '#/components/schemas/CarouselResponse'
            - $ref: '#/components/schemas/LocationResponse'
          example: { "type": "text", "value": "attenzione, hai meno di 100 euro sul conto" }
        metadata:
          type: object
        project:
          type: string
          example: "MemEx"
        type:
          type: string
          enum: [ "NOTIFICATION" ]
          example: "NOTIFICATION"
      required:
        - messageId
        - channel
        - userId
        - timestamp
        - project
        - type

    LocationRequest:
      type: object
      properties:
        type:
          type: string
          example: "location"
        longitude:
          type: number
          format: float
          example: 47.3123451
        latitude:
          type: number
          format: float
          example: 9.321151
      required:
        - type
        - longitude
        - latitude

    LocationResponse:
      type: object
      properties:
        type:
          type: string
          example: "location"
        longitude:
          type: number
          format: float
          example: 47.3123451
        latitude:
          type: number
          format: float
          example: 9.321151
        buttons:
            type: array
            items:
              $ref: '#/components/schemas/ActionResponse'
      required:
        - type
        - longitude
        - latitude

    UserInfoRequest:
      type: object
      properties:
        type:
          type: string
          enum: [ "firstName", "lastName", "profilePic", "locale", "timezone", "gender", "isPaymentEnable", "userId" ]
          example: "firstName"
        value:
          type: string
          example: "Matteo"
      required:
        - type
        - value

    TextualRequest:
      type: object
      properties:
        type:
          type: string
          example: "text"
        value:
          type: string
          example: "I want some wine"
      required:
        - type
        - value

    TextualResponse:
      type: object
      properties:
        type:
          type: string
          example: "text"
        value:
          type: string
          example: "I want to go hiking"
        buttons:
          type: array
          items:
            $ref: '#/components/schemas/ActionResponse'
      required:
        - type
        - value

    ActionRequest:
      type: object
      properties:
        type:
          type: string
          example: "action"
        value:
          type: string
          example: "Let's do it!"
      required:
        - type
        - value

    ActionResponse:
      type: object
      properties:
        type:
          type: string
          example: "action"
        buttonText:
          type: string
          example: "Cerca hotel"
        buttonId:
          type: string
          example: "BTN-DAJKSOD142-ADFGWE2"
      required:
        - type
        - buttonText

    MultiActionResponse:
      type: object
      properties:
        type:
          type: string
          example: "multiaction"
        buttons:
          type: array
          items:
            $ref: '#/components/schemas/ActionResponse'

    AttachmentRequest:
      type: object
      properties:
        type:
          type: string
          example: "attachment"
        uri:
          type: string
          example: "http://image.com/image.png"
        alternativeText:
          type: string
          example: "An hotel"
      required:
        - type
        - uri

    AttachmentResponse:
      type: object
      properties:
        type:
          type: string
          example: "attachment"
        uri:
          type: string
          example: "http://image.com/image.png"
        alternativeText:
          type: string
          example: "An hotel"
        buttons:
          type: array
          items:
            $ref: '#/components/schemas/ActionResponse'
      required:
        - type
        - uri

    CarouselResponse:
        type: object
        properties:
          type:
            type: string
            example: "carousel"
          cards:
            type: array
            items:
              $ref: '#/components/schemas/CarouselCardResponse'
        required:
          - type
          - cards

    CarouselCardResponse:
      type: object
      properties:
          title:
            type: string
            example: "Hiking activity"
          imageUrl:
            type: string
            example: "http://www.google.com/logo.png"
          subtitle:
            type: string
            example: "you should hike"
          defaultAction:
            type: object
            example: {}
          buttons:
            type: array
            items:
              $ref: '#/components/schemas/ActionResponse'
      required:
        - title

    Entity:
      type: object
      properties:
        type:
          type: string
          example: "@city"
        value:
          type: string
          example: "Boston"
        confidence:
          type: number
          format: float
          example: 0.94
      required:
        - type
        - value
        - confidence

    Log:
      type: object
      properties:
        logId:
          type: string
          example: "LOG31235141"
        project:
          type: string
          example: "memex"
        component:
          type: string
          example: "dimension"
        authority:
          type: string
          example: "nlu"
        severity:
          type: string
          enum: [ "error", "warning", "info", "debug" ]
          example: "error"
        logContent:
          type: string
          example: "bot stopped"
        timestamp:
          type: string
          example: "2019-07-04T08:33:48.35408Z"
        botVersion:
          type: string
          example: "mem-1.0.2"
        metadata:
          type: object

    Logs:
      type: array
      items:
        $ref: '#/components/schemas/Log'

    Analytic:
      oneOf:
        - $ref: '#/components/schemas/UserMetrics'
        - $ref: '#/components/schemas/MessageMetrics'
        - $ref: '#/components/schemas/ConversationMetrics'
        - $ref: '#/components/schemas/DialogueMetrics'
        - $ref: '#/components/schemas/BotMetrics'
      type: object
      properties:
        project:
          type: string
          example: "memex"
        timespan:
          type: object
          oneOf:
            - $ref: '#/components/schemas/DefaultTime'
            - $ref: '#/components/schemas/CustomTime'
        type:
          type: string
          enum: ["analytic"]
      required:
        - project
        - timespan
        - type

    Aggregation:
      type: object
      properties:
        project:
          type: string
          example: "memex"
        timespan:
          type: object
          oneOf:
            - $ref: '#/components/schemas/DefaultTime'
            - $ref: '#/components/schemas/CustomTime'
        type:
          type: string
          enum: ["aggregation"]
        field:
          type: string
          example: "messageId"
        aggregation:
          type: string
          enum: ["avg", "min", "max", "sum", "stats", "extended_stats", "value_count", "cardinality", "percentiles", "percentile_ranks"]
        filters:
          type: array
          items:
            $ref: '#/components/schemas/Filter'
      required:
        - project
        - timespan
        - type
        - field
        - aggregation

    Filter:
      type: object
      properties:
        field:
          type: string
          example: "text"
        operation:
          type: string
          enum: ["gr", "gre", "lq", "lqe", "term", "match"]
          example: "match"
        value:
          type: string
          example: "Hi"
      required:
        - field
        - operation
        - value

    UserMetrics:
      properties:
        dimension:
          type: string
          enum: ["user"]
          example: "user"
        metric:
          type: string
          enum: ["u:total", "u:active", "u:engaged", "u:new"]
      required:
        - dimension
        - metric

    MessageMetrics:
      properties:
        dimension:
          type: string
          enum: ["message"]
          example: "message"
        metric:
          type: string
          enum: ["m:from_user", "m:conversation", "m:from_bot", "m:responses", "m:notifications", "m:unhandled", "m:notification_engagement"]
      required:
        - dimension
        - metric

    ConversationMetrics:
      properties:
        dimension:
          type: string
          enum: ["conversation"]
          example: "conversation"
        metric:
          type: string
          enum: ["c:total", "c:new", "c:length", "c:path"]
      required:
        - dimension
        - metric

    DialogueMetrics:
      properties:
        dimension:
          type: string
          enum: ["dialogue"]
          example: "dialogue"
        metric:
          type: string
          enum: ["d:fallback", "d:intents", "d:domains"]
      required:
        - dimension
        - metric

    BotMetrics:
      properties:
        dimension:
          type: string
          enum: ["bot"]
          example: "bot"
        metric:
          type: string
          enum: ["b:response"]
      required:
        - dimension
        - metric

    DefaultTime:
      type: object
      properties:
        type:
          type: string
          enum: ["DEFAULT"]
          example: "DEFAULT"
        value:
          type: string
          enum: ["TODAY","1D","7D","10D","30D"]
          example: "7D"
      required:
        - type
        - value

    CustomTime:
      type: object
      properties:
        type:
          type: string
          enum: ["CUSTOM"]
          example: "CUSTOM"
        start:
          type: string
          format: date-time
          example: "2019-07-23T16:31:24.432000"
        end:
          type: string
          format: date-time
          example: "2019-07-23T16:35:50.00"
      required:
        - type
        - start
        - end

    # Responses

    HTTP_200_basic:
      type: object
      properties:
        status:
          type: string
          example: "Ok"
        code:
          enum: [ '200' ]
          example: 200

    HTTP_200:
      type: object
      properties:
        traceId:
          type: string
          example: "bcpg8XYBHD_pmQ1jA7b8"
        status:
          type: string
          example: "Object deleted"
        code:
          enum: [ '200' ]
          example: 200

    HTTP_200_ANALYTIC:
      type: object
      properties:
        query:
          oneOf:
            - $ref: '#/components/schemas/Analytic'
        result:
          type: object
          properties:
            count:
              type: number
              format: int32
            items:
              type: array
              items:
                type: string
            type:
              type: string
              example: "messageId"
        status:
          type: string
          example: '200'
        id:
          type: string
          example: 'wAu4EW4BFurD9NUGZY3z'

    HTTP_500_ANALYTIC:
      type: object
      properties:
        message:
          type: string

    HTTP_201:
      type: object
      properties:
        traceId:
          type: string
          example: "bcpg8XYBHD_pmQ1jA7b8"
        status:
          type: string
          example: "Object Created"
        code:
          enum: [ '201' ]
          example: 201

    HTTP_201_list:
      type: object
      properties:
        traceIds:
          type: array
          items:
            type: string
            example: "bcpg8XYBHD_pmQ1jA7b8"
        status:
          type: string
          example: "Created"
        code:
          enum: [ '201' ]
          example: 201

    200_event_count:
      type: object
      properties:
        type:
          enum: ['click_per_event']
        event:
          type: string
          example: "EV321423"
        click:
          type: object
        status:
          enum: ['ok']
        cose:
          enum: [ '200' ]

    200_user_count:
      type: object
      properties:
        type:
          enum: ['click_per_user']
        user:
          type: string
          example: "USR30942"
        click:
          type: object
        status:
          enum: ['ok']
        cose:
          enum: [ '200' ]

    HTTP_400:
      type: object
      properties:
        status:
          type: string
          example: "Malformed request"
        code:
          enum: [ '400' ]
          example: 400

    HTTP_404_basic:
      type: object
      properties:
        status:
          type: string
          example: "Not found"
        code:
          enum: [ '404' ]
          example: 404

    HTTP_404:
      type: object
      properties:
        traceId:
          type: string
          example: "bcpg8XYBHD_pmQ1jA7b8"
        status:
          type: string
          example: "Cannot find message {traceId} in the database"
        code:
          enum: [ '404' ]
          example: 404

    HTTP_500:
      type: object
      properties:
        status:
          type: string
          example: "Internal server error"
        code:
          enum: [ '500' ]
          example: 500
